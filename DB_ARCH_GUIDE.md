# 금융권 본인인증 DB 구조 설계 가이드 (with 개인정보보호법/신용정보법)

이 문서는 금융사(위탁사)와 본인인증기관(수탁사) 간의 데이터 저장 구조를 법적 준수 사항(개인정보보호법, 신용정보법)을 고려하여 설계한 가이드입니다.

## 1. 법적 핵심 원칙 (Compliance Key Points)

1.  **데이터 최소화 원칙**: 본인인증 목적 달성에 필요한 최소한의 정보만 수집/저장해야 합니다.
2.  **주민등록번호 암호화 및 보관 제한**: 
    *   **금융사**: 법적 근거 없이는 주민등록번호 원문을 평문으로 저장할 수 없습니다. 대신 **CI(연계정보)**를 사용하여 사용자를 식별해야 합니다.
    *   **본인인증기관**: 본인확인기관 지정 사업자(통신사, 신평사 등)는 주민등록번호를 수집/처리할 수 있으나, 반드시 암호화하여 별도 망에 보관해야 합니다.
3.  **목적 외 이용 금지**: 수탁받은 개인정보(전화번호 등)를 마케팅 목적으로 활용해서는 안 됩니다.

---

## 2. 권장 DB 구조 (To-Be Model)

실무에서 안전하게 운영하기 위해 위탁사와 수탁사가 각각 보유해야 할 데이터입니다.

### [A] 위탁사 (금융사/쇼핑몰) DB
금융사는 "**누가(식별)** **언제(로그)** 인증했는가"에 집중합니다.

| 테이블 | 컬럼 예시 | 설명 및 법적 근거 |
| :--- | :--- | :--- |
| **Users (회원)** | `user_uuid` (PK) | 내부 식별자 |
| | `ci` (연계정보) | **[중요]** 주민등록번호 대신 개인을 유일하게 식별하는 88byte 표준 암호화 키. (모든 금융권 공통 식별자) |
| | `name`, `phone` | 마스킹 처리하거나 암호화하여 저장 (필요 시) |
| | `di` (중복가입확인정보) | 1인 1계정 체크용 (사이트별 고유값) |
| **Auth_Logs (이력)** | `auth_request_id` (PK) | 수탁사에 보낸 요청 ID |
| | `user_uuid` (FK) | 요청한 사용자 |
| | `trustee_id` | 이용한 인증기관 (V-PASS, PASS, Toss 등) |
| | `result_code` | 인증 성공/실패 결과 |
| | `auth_token_ref` | 수탁사가 발급한 JWT 또는 토큰 ID |
| | `req_time`, `res_time` | 감사(Audit) 로그용 타임스탬프 |

> **🚫 주의**: 금융사는 사용자의 **주민등록번호 뒷자리**를 DB에 저장하지 않는 것이 원칙입니다. (CI값으로 대체)

### [B] 수탁사 (본인인증기관) DB
수탁사는 "**정확한 신원 확인**"을 위해 실명 정보를 보유하거나 통신사와 연계합니다.

| 테이블 | 컬럼 예시 | 설명 및 법적 근거 |
| :--- | :--- | :--- |
| **Auth_Sessions (세션)** | `jti` / `token_id` (PK) | 인증 세션 고유 ID |
| | `auth_request_id` | 위탁사에서 보낸 요청 ID (매핑용) |
| | `phone_hash` | 전화번호 (단방향 해시 또는 암호화 저장 권장) |
| | `status` | PENDING, COMPLETED, EXPIRED |
| | `otp_hash` | 발송된 OTP (평문 저장 지양, 해시 후 비교 권장) |
| | `expire_at` | 만료 시간 (TTL 설정 필수) |
| **Carrier_Master (원장)** | `rrn_encrypted` | **[특수]** 주민등록번호 (AES-256 등 강력한 암호화 필수) |
| | `name`, `phone` | 실명 인증을 위한 기초 데이터 |
| | `ci`, `di` | 위탁사에 내려주기 위한 생성 값 |
| | `carrier_code` | 통신사 정보 (SKT, KT, LGU+) |

---

## 3. 현재 프로젝트 구조 (Current Implemented Model)

**2026-01-27 업데이트**: 개인정보보호법 준수를 위한 **암호화, CI, 데이터 파기** 기능이 코드에 반영되었습니다.

### [A] 위탁사 (entrusting-client)
*   **User 테이블**:
    *   `ci` (Connect Information): **[Unique]** 중복 가입 방지 및 사용자 식별을 위한 키.
    *   `name`, `phoneNumber`: **[AES-256 암호화]** 평문 저장 없이 암호화된 상태로 저장.
    *   `di`: 사이트별 중복확인정보 (구현 준비)

### [B] 수탁사 (vpass-provider)
*   **AuthToken 테이블**:
    *   `ci`: 인증 완료 시 생성된 암호화된 연계정보.
    *   `name`, `clientData(phone)`: **[AES-256 암호화]** 저장 시 자동 암호화, 검증 시 복호화.
*   **데이터 수명 관리 (TTL)**:
    *   **Scheduler**: 인증 데이터(`AuthToken`)는 생성 후 **3분**이 지나면 스케줄러에 의해 **영구 삭제(Hard Delete)**됩니다.

---

## 4. 향후 개발 시 적용 포인트 (Completed)

다음 항목들은 모두 코드 레벨에서 구현이 완료되었습니다. (vpass-backend 빌드 완료)

1.  **CI (Connecting Information) 도입**:
    *   수탁사(`vpass`)가 인증 완료 시 JWT에 `CI` 값을 포함하여 반환하도록 수정됨.
    *   위탁사(`entrusting`)는 회원 테이블에 `CI` 컬럼을 추가하고, 이를 기준으로 중복 가입을 방지함.
2.  **데이터 암호화**:
    *   DB에 `AES-256` 알고리즘을 적용하여 전화번호 및 이름 암호화 저장 완료.
3.  **데이터 파기(TTL)**:
    *   수탁사의 인증 데이터(`AuthToken`)는 인증 후 3분 내에 완전히 파기되도록 `AuthTokenCleanupService` 구현 완료.
